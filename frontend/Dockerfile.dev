FROM node:22-alpine

# Install pnpm for cyphertap build
RUN npm install -g pnpm

# Build cyphertap first
WORKDIR /cyphertap
COPY cyphertap/package.json cyphertap/pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

COPY cyphertap/ .
RUN pnpm run build:css && pnpm run prepack || pnpm run build

# Verify dist was created
RUN ls -la /cyphertap/dist/

# Now set up frontend
WORKDIR /app
COPY frontend/package*.json ./

# Install frontend dependencies first
RUN npm install --install-links

# Also install cyphertap's peer dependencies that are needed at runtime
RUN npm install embla-carousel-svelte

COPY frontend/ .

EXPOSE 5173

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
